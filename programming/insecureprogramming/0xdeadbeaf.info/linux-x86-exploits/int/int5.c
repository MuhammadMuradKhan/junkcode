/*
 * $Id: int5.c,v 1.1.1.1 2004/05/29 14:15:05 raptor Exp $
 *
 * int5.c - vulnerable program (int/short array overflows)
 * Copyright (c) 2003 Marco Ivaldi <raptor@0xdeadbeef.info>
 *
 * See http://fakehalo.deadpig.org/IAO-paper.txt, by vade79/v9.
 */

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

char *gettoken(char *, int, unsigned int);
void place_int_array(char *);

int main(int argc, char **argv)
{
	if (argc != 2)
		printf("syntax: %s [value, value, ...]\n", argv[0]);
	else
		place_int_array(argv[1]);

	exit(0);
}

void place_int_array(char *slot_values)
{
	unsigned int i = 0;
	int array[32];
	char *ptr;

	while ( ptr = gettoken(slot_values, i, ',') ) {

		array[i] = atoi(ptr);	/* the overwrite itself */

		printf("placed %d in array slot %u\n", atoi(ptr), i);
		i++;
	}

	return;
}

char *gettoken(char *string, int i, unsigned int sep)
{
	unsigned int j = 0, k = 0;
	char *buf;

	if ( !(buf = (char *)malloc(strlen(string) + 1)) )
		exit(1);
	
	memset(buf, 0x0, strlen(string) + 1);

	if (i < 0)
		return(NULL);
	else
		for (j = 0; j < strlen(string); j++) {
			if (string[j] == sep)
				i--;
			else if (!i)
				buf[k++] = string[j];
			if (string[j] == 0x0a || string[j] == 0x0)
				j = strlen(string) + 1;
		}

	if (i > 0)
		return(NULL);

	return(buf);
}
