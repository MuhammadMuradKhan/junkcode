/*
 * $Id: remote2.c,v 1.1.1.1 2004/05/29 14:15:05 raptor Exp $
 *
 * remote2.c - vulnerable code (remote format strings)
 * Copyright (c) 2003 Marco Ivaldi <raptor@0xdeadbeef.info>
 *
 * An example vulnerable network daemon.
 */

#include <stdio.h>
#include <netdb.h>
#include <netinet/in.h>

#define BUFFER_SIZE 1024
#define NAME_SIZE 2048
#define PORT 1234

int handling(int c)
{
	char buffer[BUFFER_SIZE], name[NAME_SIZE];
	int bytes;

	strcpy(buffer, "> ");
	bytes = send(c, buffer, strlen(buffer), 0);
	if (bytes < 0)
		return -1;

	bytes = recv(c, name, sizeof(name), 0);

	if (bytes < 0)
		return -1;

	name[bytes -1] = 0;

	snprintf(buffer, sizeof(buffer), name);
	buffer[sizeof(buffer) - 1] = 0x0;
	bytes = send(c, buffer, strlen(buffer), 0);

	if (bytes < 0)
		return -1;

	return 0;
}

int main(int argc, char *argv[])
{
	int s, c, cli_size;
	struct sockaddr_in srv, cli;

	if ((s = socket(AF_INET, SOCK_STREAM, 0)) < 0) {
		perror("socket");
		return 2;
	}

	srv.sin_addr.s_addr = INADDR_ANY;
	srv.sin_port = htons(PORT);
	srv.sin_family = AF_INET;

	if (bind(s, &srv, sizeof(srv)) < 0) {
		perror("bind");
		return 3;
	}

	if (listen(s, 3) < 0) {
		perror("listen");
		return 4;
	}

	for (;;) {
		
		c = accept(s, &cli, &cli_size);

		if (c < 0) {
			perror("accept");
			return 5;
		}

		printf("client from %s", inet_ntoa(cli.sin_addr));
		if (handling(c) < 0)
			fprintf(stderr, "%s: handling() failed", argv[0]);
		close(c);
	}

	return(0);
}
